# VibeIntelligence Configuration
# This should be added to the main borg.tools configuration or as a separate file

# Subdomain configuration for vi.borg.tools
server {
    listen 80;
    listen [::]:80;
    server_name vi.borg.tools;
    
    # Frontend proxy
    location / {
        proxy_pass http://localhost:8101;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend API proxy
    location /api {
        proxy_pass http://localhost:8100;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Add this location block to the existing borg.tools server block
# Inside the server block for borg.tools (port 80 or 443)
location /vi {
    # Remove trailing slash and proxy to frontend
    rewrite ^/vi$ /vi/ permanent;
    rewrite ^/vi/(.*)$ /$1 break;
    
    proxy_pass http://localhost:8101;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Handle subdirectory properly
    sub_filter_once off;
    sub_filter 'href="/' 'href="/vi/';
    sub_filter 'src="/' 'src="/vi/';
    sub_filter 'action="/' 'action="/vi/';
}

location /vi/api {
    rewrite ^/vi/api(.*)$ /api$1 break;
    proxy_pass http://localhost:8100;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}